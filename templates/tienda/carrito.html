{% extends "layout.html" %}
{% block tienda %}
<h2>Tu carrito</h2>
<div id="items-carrito"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const contenedor = document.getElementById("items-carrito");
  let ids = [];

  // 1. Recolectar los IDs guardados en localStorage
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith("")) {
      const id = key.replace("", "");
      ids.push(id);
    }
  }

  // 2. Verificar si hay productos y hacer la petición al backend
  if (ids.length > 0) {
    fetch(`/tienda/obtener_desde_localstorage/?ids=${ids.join(",")}`)
      .then(response => response.json())
      .then(productos => {
        console.log("Productos recibidos:", productos); // DEBUG en consola
        let total = 0;

        productos.forEach(producto => {
          const cantidad = parseInt(localStorage.getItem(producto.id));
          const subtotal = producto.precio * cantidad;
          total += subtotal;

          contenedor.innerHTML += `
            <div class="producto">
              <img src="${producto.imagen}" width="100" />
              <h3>${producto.nombre}</h3>
              <p>Precio: $${producto.precio}</p>
              <p>Cantidad: ${cantidad}</p>
              <p>Subtotal: $${subtotal}</p>
              <hr>
            </div>
          `;
        });

        contenedor.innerHTML += `<h3>Total: $${total}</h3>`;
      })
      .catch(error => {
        console.error("Error al traer productos:", error);
        contenedor.innerHTML = "<p>Error al cargar el carrito.</p>";
      });
  } else {
    contenedor.innerHTML = "<p>Tu carrito está vacío.</p>";
  }
});
</script>
{% endblock %}
